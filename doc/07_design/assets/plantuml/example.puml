@startuml

!include protopipe-skin.puml


!$BG = "#081a17"
!$PANEL = "#0d2622"
!$LINE = "#2b3a37"
!$FG = "#F2F4F3"
!$MUTED = "#A9B4B0"
!$ACCENT = "#de083d"
!$ACC2 = "#f7436e"
title Protopipe - Example

actor User
actor "Management / PM" as PM
rectangle "Protopipe Cockpit\n(Experiments, KPIs, Governance)" as Cockpit
rectangle "GitLab CI/CD\n(Feature Branch Builds,\nSnapshots)" as GitLab

node "Kubernetes Cluster" {
  rectangle "Protopipe Operator\n(CRD -> Runtime Config)" as Operator
  rectangle "Protopipe FE Composer\n(Page SSR + Composition)" as Composer
  rectangle "Message Bridge\n(/messages polling)" as Bridge
  rectangle "Overwatch\n(OTel Collector + Event Archive)" as Overwatch

  rectangle "Backend Services\n(Domain APIs)" as BE
  database "Shared Session/State Store\n(clustered)" as Store
}

User --> Composer : HTTP(S)\nPage Request
Composer --> BE : parallel calls\n(GET/forwardBody optional)
Composer --> Bridge : poll /messages\n(optional client)
Composer --> Overwatch : traces/events/metrics
Composer --> Store : session/state lookup\n(optional)
PM --> Cockpit : define/toggle experiments\nview KPIs
Cockpit --> Operator : create/update Experiment CRD
GitLab --> Operator : publish snapshots\n(artifact registry)
Operator --> Composer : resolved routing/config\n(status/effective)

@enduml

